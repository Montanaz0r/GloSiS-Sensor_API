#+ summary: "Retrieves all the information about ILIAD Observations"
#+ description: "NOTE: make sure response content type is application/json"
#+ endpoint: "https://www.foodie-cloud.org/sparql"
#+ tags:
#+   - json
#+ method: GET
#+ pagination: 100
#+ endpoint_in_url: False
#+ transform: {
#+   "description": "?info",
#+   "$anchor": "description",
#+   "@iot.count": "?total",
#+   "@iot.nextLink": "?next_link",
#+ }

PREFIX lucas-api: <https://w3id.org/glosis/lucas/api/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema/>
PREFIX sosa:  <http://www.w3.org/ns/sosa/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema/>
PREFIX qudt: <http://qudt.org/schema/qudt/>

SELECT DISTINCT ?info ?total ?next_link 
WHERE {
    ?s rdf:type/rdfs:subClassOf* sosa:Observation ;
      rdfs:label ?label ;
      sosa:FeatureOfInterest ?foi ;
      sosa:observedProperty ?obs_prop ;
      sosa:hasResult ?result ;
      sosa:resultTime ?resultTime ;
			sosa:phenomenonTime ?phenomenonTime .
		BIND ("OGC SensorThings API - Observations" as ?info)
    BIND (REPLACE(STR(?s), "^.*/([^/]*)$", "$1") as ?id)
    BIND (URI(CONCAT('https://w3id.org/glosis/lucas/api/v1.0/Observations(', ?id,')')) AS ?id_link)
    BIND (URI(CONCAT('https://w3id.org/glosis/lucas/api/v1.0/Observations(', ?id,')/Datastream')) AS ?datastream_link)
    BIND (URI(CONCAT('https://w3id.org/glosis/lucas/api/v1.0/Observations(', ?id,')/FeatureOfInterest')) AS ?feature_link)
    {
       SELECT (count(*) as ?total) WHERE { ?x rdf:type/rdfs:subClassOf* sosa:Observation }
    }
    OPTIONAL { ?s ?p ?_page } 
    BIND (URI(CONCAT('https://w3id.org/glosis/lucas/api/v1.0/Observations?$top=100&$skip=', (xsd:integer(?_page)+1)*100)) AS ?next_link)
}
ORDER BY ?id
